image: docker:stable

services:
  - docker:dind

variables:
  DOCKER_DRIVER: vfs
  DOCKER_TLS_CERTDIR: ""

stages:
  - test
  - build

before_script:
  - apk add --no-cache python3 py3-pip
  - pip3 install --upgrade pip setuptools wheel
  - pip3 install docker-compose

cache:
  paths:
    - node_modules/

test:
  stage: test
  script:
    - docker info
    - docker-compose --version
    - apk add --no-cache bash
    - apk add --no-cache git
    - apk add --no-cache npm
    - apk add --no-cache nodejs
    - npm ci
    - npm test

build:
  stage: build
  script:
    - docker info
    - docker-compose --version
    - apk add --no-cache bash
    - apk add --no-cache git
    - apk add --no-cache npm
    - apk add --no-cache nodejs
    - npm ci
    - npm install -g expo-cli
    - expo build:android --non-interactive --no-wait --type apk
  artifacts:
    paths:
      - ./dist
